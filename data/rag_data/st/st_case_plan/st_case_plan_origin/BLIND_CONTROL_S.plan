{"variables": [], "instructions": [], "planning": "- 概述\n  这段代码实现了一个名为 `BLIND_CONTROL_S` 的功能块，用于控制百叶窗或类似设备的上升和下降动作。它通过处理输入信号（如上升、下降、位置反馈等）来控制输出信号（如电机上升、电机下降、当前位置等），并管理状态转换和超时逻辑。\n\n- 变量定义\n  代码中定义了以下几类变量：\n  - 输入变量：包括上升 (`UP`)、下降 (`DN`)、初始位置 (`S_IN`)、位置反馈 (`PI`)、上升时间 (`T_UP`)、下降时间 (`T_DN`)、复位上升 (`RU`)、复位下降 (`RD`)、锁定时间 (`T_LOCKOUT`)、扩展时间 (`T_EXT`)、扩展触发值 (`EXT_TRIG`)、顶部参考位置 (`R_POS_TOP`)、底部参考位置 (`R_POS_BOT`)。\n  - 输出变量：包括当前位置 (`POS`)、电机上升 (`MU`)、电机下降 (`MD`)、状态 (`STATUS`)。\n  - 内部变量：包括斜坡函数块 (`rmp`)、当前时间 (`tx`)、上次时间 (`last`)、上次位置反馈 (`PI_last`)。\n\n- - 主逻辑部分\n  -- REGION 初始化与时间计算\n    首先，使用 `OSCAT_BASIC.T_PLC_MS()` 获取当前时间（以毫秒为单位），并将其转换为 `TIME` 类型，存储在变量 `tx` 中。这个时间值用于后续的时间差计算和超时判断。\n\n  -- REGION 输入处理与状态设置\n    根据 `UP` 和 `DN` 输入信号，设置 `rmp.IN` 的值和 `STATUS` 状态：\n    - 如果 `UP` 为真且 `DN` 为假，表示需要执行上升动作。此时，设置 `rmp.IN` 为 255（最大值），并将 `STATUS` 设置为 121（上升状态）。\n    - 如果 `DN` 为真且 `UP` 为假，表示需要执行下降动作。此时，设置 `rmp.IN` 为 0（最小值），并将 `STATUS` 设置为 122（下降状态）。\n    - 如果 `UP` 和 `DN` 都为假，表示没有上升或下降动作。此时，设置 `rmp.IN` 为 `PI`（位置反馈），并将 `STATUS` 设置为 `S_IN`（初始状态）。\n\n  -- REGION 斜坡函数块调用\n    调用斜坡函数块 `rmp`，传入以下参数：\n    - `E`：使能信号，为 `UP` 或 `DN` 的逻辑或结果。\n    - `TR`：上升时间 (`T_UP`)。\n    - `TF`：下降时间 (`T_DN`)。\n    - `TL`：锁定时间 (`T_LOCKOUT`)。\n    - `OUT`：输出当前位置 `POS`。\n\n    该函数块会根据输入参数和当前状态，平滑地调整 `POS` 的值，模拟百叶窗的上升和下降过程。\n\n  -- REGION 状态机处理\n    根据 `STATUS` 的值，执行不同的逻辑：\n    - 状态 0：初始化状态。设置 `last` 为当前时间 `tx`，`PI_last` 为 `PI` 的反值（`PI XOR BYTE#255`），并将 `STATUS` 设置为 128（初始化完成）。\n    - 状态 121：上升状态。设置 `MU` 为真（电机上升），`MD` 为假（电机下降）。如果 `POS` 接近最大值（255 - `EXT_TRIG`），表示上升动作即将完成，将 `POS` 设置为 255，更新 `last` 为当前时间 `tx`，并将 `STATUS` 设置为 129（上升完成）。\n    - 状态 122：下降状态。设置 `MD` 为真（电机下降），`MU` 为假（电机上升）。如果 `POS` 接近最小值（`EXT_TRIG`），表示下降动作即将完成，将 `POS` 设置为 0，更新 `last` 为当前时间 `tx`，并将 `STATUS` 设置为 129（下降完成）。\n    - 状态 123：位置调整状态。设置 `MD` 和 `MU` 为 `rmp.DN` 和 `rmp.UP`。如果 `POS` 接近最小值或最大值，则设置相应的电机动作，并更新 `last` 为当前时间 `tx`，将 `STATUS` 设置为 129。否则，将 `STATUS` 设置为 `S_IN`。\n    - 状态 124：参考位置调整状态。设置 `MD` 和 `MU` 为 `rmp.DN` 和 `rmp.UP`。如果 `rmp.DN` 和 `rmp.UP` 都为假，表示调整完成，更新 `PI_last` 为 `PI`，并将 `STATUS` 设置为 `S_IN`。\n    - 状态 127：锁定状态。如果当前时间与 `last` 的时间差大于 `T_LOCKOUT`，表示锁定时间已过，将 `STATUS` 设置为 `S_IN`。\n    - 状态 128：初始化完成状态。设置 `MU` 为真（电机上升），`MD` 为假（电机下降），并设置 `rmp.IN` 为 255。如果当前时间与 `last` 的时间差大于 `T_UP + T_EXT`，表示上升动作完成，设置 `MU` 为假，更新 `last` 为当前时间 `tx`，并将 `STATUS` 设置为 127。\n    - 状态 129：动作完成状态。如果当前时间与 `last` 的时间差大于 `T_EXT`，表示扩展时间已过，设置 `MU` 和 `MD` 为假，更新 `last` 为当前时间 `tx`，并将 `STATUS` 设置为 127。\n    - 默认状态：设置 `MU` 和 `MD` 为假。如果 `PI` 不等于 `PI_last`，表示位置反馈发生变化，更新 `PI_last` 为 `PI`，并将 `STATUS` 设置为 123。如果 `POS` 为 0 且 `RU` 为真，表示需要调整到底部参考位置，设置 `rmp.IN` 为 `R_POS_BOT`，并将 `STATUS` 设置为 124。如果 `POS` 为 255 且 `RD` 为真，表示需要调整到顶部参考位置，设置 `rmp.IN` 为 `R_POS_TOP`，并将 `STATUS` 设置为 124。否则，将 `STATUS` 设置为 `S_IN`。\n\n  -- REGION 结束\n    功能块执行结束，输出当前状态和位置。`POS` 表示百叶窗的当前位置，`MU` 和 `MD` 分别表示电机上升和下降的状态，`STATUS` 表示当前的状态码。", "name": "BLIND_CONTROL_S"}