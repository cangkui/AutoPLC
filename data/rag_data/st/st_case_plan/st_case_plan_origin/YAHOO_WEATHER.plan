{"variables": [], "instructions": [], "planning": "- 概述\n  这段代码是一个使用SCL编写的功能块，名为“YAHOO_WEATHER”，用于从Yahoo Weather API获取天气数据。它通过HTTP请求获取数据，并使用XML解析器解析响应内容，最终将数据存储在结构体中。功能块还处理了错误检测、重试机制和状态管理。\n\n- 变量定义\n  代码中定义了以下几类变量：\n  - 输入输出变量：IP控制结构、网络缓冲区、Yahoo天气数据\n  - 输入变量：激活标志、单位标志、位置字符串\n  - 输出变量：忙标志、完成标志、错误代码、错误类型\n  - 内部变量：XML控制、XML读取器、URL数据、DNS客户端、HTTP获取、激活标志上一次状态、整数值、实数值、状态、循环计数、天数索引、索引、计数、重试请求标志、重试等待时间、重试计数、最大重试计数、重试时间戳、时间戳\n\n- - 主逻辑部分\n  -- REGION STATE MACHINE\n     此区域实现了功能块的状态机，用于管理从Yahoo Weather API获取天气数据的流程。状态机通过CASE语句实现，每个状态对应一个特定的操作。以下是每个状态的详细逻辑：\n     - **状态00**：初始化状态，检查是否激活功能块。\n       - 如果`ACTIVATE`为真且`activate_last`为假（即激活信号从假变为真），则进入状态40。\n       - 初始化相关变量：`DONE`设为假，`BUSY`设为真，`ERROR_C`和`ERROR_T`清零，`cycle`和`repeat_count`重置为0，`repeat_request`设为假。\n       - 设置URL的域名为`query.yahooapis.com`。\n\n     - **状态40**：处理DNS解析。\n       - 调用`DNS_CLIENT`功能块解析URL的域名。\n       - 如果DNS解析完成（`DNS_CLIENT.DONE`为真），则进入状态50。\n       - 如果DNS解析出错（`DNS_CLIENT.ERROR > 0`），则设置错误代码和类型，并跳转到状态100。\n\n     - **状态50**：构建URL查询字符串。\n       - 根据`cycle`的值构建不同的查询字符串：\n         - 如果`cycle = 0`，则查询字符串为`q=select%20units,wind,atmosphere,astronomy,location%20from%20weather.forecast%20where%20woeid=`。\n         - 否则，查询字符串为`q=select%20item%20from%20weather.forecast%20where%20woeid=`。\n       - 将`LOCATION`拼接到查询字符串中。\n       - 根据`UNITS`的值，决定是否添加单位参数（`u=%27f%27`表示华氏度，`u=%27c%27`表示摄氏度）。\n       - 设置URL的路径为`/v1/public/yql`。\n       - 进入状态60。\n\n     - **状态60**：发送HTTP GET请求。\n       - 调用`HTTP_GET`功能块发送HTTP请求。\n       - 如果请求完成（`HTTP_GET.DONE`为真），则进入状态80。\n       - 如果请求出错（`HTTP_GET.ERROR > 0`），则设置错误代码和类型，并跳转到状态100。\n\n     - **状态80**：解析XML响应。\n       - 调用`XML_READER`功能块解析HTTP响应体。\n       - 如果`CTRL.TYP < 98`（即解析成功），则处理解析结果：\n         - 将解析的字符串值转换为实数值或整数值，并存储在`value_real`和`value_int`中。\n         - 根据`cycle`的值，将解析结果存储到`YW`结构体的相应字段中：\n           - 如果`cycle = 0`，则处理位置、风速、大气、天文和单位信息。\n           - 否则，处理地理坐标、当前天气条件和未来天气预报信息。\n         - 如果`ctrl.COUNT = 7`且`ctrl.VALUE = '0'`，则表示需要重试请求。增加`repeat_count`，如果超过最大重试次数，则设置错误代码和类型，并跳转到状态100。否则，设置`repeat_request`为真，并跳转到状态100。\n       - 如果`CTRL.TYP = 99`（即解析完成），则跳转到状态100。\n\n     - **状态100**：检查是否需要重试请求。\n       - 如果`repeat_request`为真，则记录当前时间戳`repeat_tx`，并进入状态110。\n       - 如果`cycle = 0`且无错误（`ERROR_T = 0`），则进入状态50，并增加`cycle`和重置`repeat_count`。\n       - 否则，进入状态0，并设置`BUSY`为假，`DONE`为真（如果无错误）。\n\n     - **状态110**：等待重试时间。\n       - 如果当前时间戳`tx`大于`repeat_tx + repeat_wait_time`，则重置`repeat_request`为假，并进入状态50。\n\n  -- REGION DNS_CLIENT\n     此区域调用`DNS_CLIENT`功能块，用于解析URL的域名。\n     - 根据当前状态（`state=40`），激活DNS解析。\n\n  -- REGION HTTP_GET\n     此区域调用`HTTP_GET`功能块，用于发送HTTP GET请求。\n     - 根据当前状态（`state=60`），激活HTTP请求。\n     - 在状态100时，解锁网络缓冲区。\n\n  -- REGION activate_last\n     此区域更新`activate_last`变量，用于检测`ACTIVATE`信号的边缘变化。\n     - 将`ACTIVATE`的当前值赋给`activate_last`，以便在下一次循环中检测边缘变化。\n\n- 输出结果\n  功能块的输出结果包括忙标志、完成标志、错误代码和错误类型。\n  - 如果功能块成功完成，则`DONE`为真，`BUSY`为假。\n  - 如果发生错误，则`ERROR_C`和`ERROR_T`会指示错误的具体原因。\n  - `BUSY`标志在功能块处理过程中为真，处理完成后为假。", "name": "YAHOO_WEATHER"}