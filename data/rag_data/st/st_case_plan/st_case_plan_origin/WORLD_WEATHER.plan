{"variables": [], "instructions": [], "planning": "- 概述\n此功能块名为`WORLD_WEATHER`，用于从World Weather Online API获取天气数据。它通过HTTP请求获取天气信息，并将数据解析为结构化的格式。功能块通过状态机控制整个流程，包括URL生成、DNS解析、HTTP请求、数据解析和错误处理。\n\n- 变量定义\n代码中定义了以下几类变量：\n - 输入输出变量：`IP_C`（IP控制结构）、`S_BUF`（发送缓冲区）、`R_BUF`（接收缓冲区）、`WW`（天气数据结构）。\n - 输入变量：`ACTIVATE`（激活信号）、`LATITUDE`（纬度）、`LONGITUDE`（经度）、`KEY`（API密钥）。\n - 输出变量：`BUSY`（忙信号）、`DONE`（完成信号）、`ERROR_C`（错误代码）、`ERROR_T`（错误类型）。\n - 内部变量：用于URL生成、DNS解析、HTTP请求、CSV解析、状态控制等。\n\n- - 主逻辑部分\n-- REGION 00: 初始化\n   此状态是功能块的初始状态。当`ACTIVATE`信号从假变为真时，功能块开始工作。此时，状态设置为20，`BUSY`信号为真，表示功能块正在处理任务。`DONE`信号和错误信号被重置为假和0，表示任务未完成且没有错误发生。\n\n-- REGION 20: URL生成\n   在此状态下，功能块根据输入的纬度和经度生成API请求的URL。首先，将纬度转换为字符串，并拼接到URL中。然后，将经度转换为字符串，并拼接到URL中。最后，将API密钥拼接到URL中，形成完整的请求URL。生成的URL字符串被转换为URL数据结构，以便后续的HTTP请求使用。状态设置为40，进入DNS解析阶段。\n\n-- REGION 40: DNS解析\n   在此状态下，功能块使用`DNS_CLIENT`功能块解析URL中的域名。`DNS_CLIENT`功能块将域名转换为IP地址。如果解析成功，状态设置为60，进入HTTP请求阶段。如果解析失败，记录错误代码和错误类型，并跳转到状态100，进入错误处理阶段。\n\n-- REGION 60: HTTP请求\n   在此状态下，功能块使用`HTTP_GET`功能块发送HTTP请求，获取天气数据。`HTTP_GET`功能块根据解析得到的IP地址和URL数据发送HTTP GET请求。如果请求成功，状态设置为80，进入数据解析阶段。如果请求失败，记录错误代码和错误类型，并跳转到状态100，进入错误处理阶段。\n\n-- REGION 80: 数据解析\n   在此状态下，功能块使用`CSV_PARSER_BUF`功能块解析HTTP响应的CSV数据。解析过程从HTTP响应的起始位置开始，逐行解析CSV数据。解析后的数据被存储到天气数据结构`WW`中，包括当前天气和未来几天的天气预报。具体解析逻辑如下：\n   - 如果解析结果为1或2，表示解析到有效的CSV数据。将解析到的字符串转换为整数或实数，并存储到相应的字段中。\n   - 如果解析结果为10，表示CSV数据解析完成。`DONE`信号设置为真，表示功能块已完成工作。状态设置为100，进入完成与错误处理阶段。\n   - 在解析过程中，功能块会根据解析到的字段类型和位置，将数据存储到`WW`结构中的相应字段。例如，当前天气的温度、风速、风向等信息，以及未来几天的天气预报。\n\n-- REGION 100: 完成与错误处理\n   在此状态下，功能块处理任务完成或错误发生的情况。具体逻辑如下：\n   - 如果HTTP请求未完成，状态重置为0，`BUSY`信号为假，`DONE`信号根据错误类型设置。如果错误类型为0，`DONE`信号为真；否则，`DONE`信号为假。\n   - 如果HTTP请求已完成，功能块进入等待状态，直到`ACTIVATE`信号再次激活。此时，功能块可以重新开始工作，获取新的天气数据。\n\n- 功能块调用\n-- DNS_CLIENT: 用于解析URL中的域名。将域名转换为IP地址，以便后续的HTTP请求使用。\n-- HTTP_GET: 用于发送HTTP请求并获取天气数据。根据解析得到的IP地址和URL数据发送HTTP GET请求，获取天气数据的CSV文件。\n-- CPB (CSV_PARSER_BUF): 用于解析HTTP响应的CSV数据。逐行解析CSV文件，将解析到的数据存储到天气数据结构`WW`中。\n\n- 状态机\n功能块通过状态机控制整个流程，包括URL生成、DNS解析、HTTP请求、数据解析和错误处理。每个状态都有相应的处理逻辑，确保功能块能够正确地获取和解析天气数据。状态机的状态转换如下：\n - 00 -> 20: 当`ACTIVATE`信号从假变为真时，功能块开始工作。\n - 20 -> 40: URL生成完成后，进入DNS解析阶段。\n - 40 -> 60: DNS解析成功后，进入HTTP请求阶段。\n - 40 -> 100: DNS解析失败后，进入错误处理阶段。\n - 60 -> 80: HTTP请求成功后，进入数据解析阶段。\n - 60 -> 100: HTTP请求失败后，进入错误处理阶段。\n - 80 -> 100: 数据解析完成后，进入完成与错误处理阶段。\n - 100 -> 00: 任务完成后，功能块进入等待状态，直到`ACTIVATE`信号再次激活。\n\n- 错误处理\n功能块在DNS解析、HTTP请求和数据解析过程中可能会遇到错误。每个错误都会被记录，并通过`ERROR_C`和`ERROR_T`输出。错误类型包括：\n - DNS解析错误（类型1）：表示域名解析失败。\n - HTTP请求错误（类型2）：表示HTTP请求失败。\n 如果发生错误，功能块会跳转到状态100，进入错误处理阶段，并输出相应的错误代码和错误类型。\n\n- 输出结果\n功能块的输出包括：\n - `BUSY`信号：表示功能块正在处理任务。\n - `DONE`信号：表示功能块已完成工作。\n - `ERROR_C`：错误代码，表示发生的错误类型。\n - `ERROR_T`：错误类型，表示错误的来源（DNS解析或HTTP请求）。\n 解析后的天气数据存储在`WW`结构中，包括当前天气和未来几天的天气预报。这些数据可以在后续的程序中使用，例如显示在用户界面上或用于其他计算。", "name": "WORLD_WEATHER"}