{"variables": [], "instructions": [], "planning": "- 概述\n  该功能块 `DLOG_FILE_TO_SMTP` 用于将日志文件通过 SMTP 协议发送到指定的邮件服务器。它处理文件的读取、SMTP 邮件的发送以及错误处理。功能块的核心逻辑是通过状态机控制文件的读取和邮件的发送过程，同时支持重试机制和错误检测。\n\n- 变量定义\n  代码中定义了以下几类变量：\n  - 输入输出变量：`SERVER`（邮件服务器地址）、`MAILFROM`（发件人地址）、`MAILTO`（收件人地址）、`SUBJECT`（邮件主题）、`BODY`（邮件正文）、`X`（日志文件数据）。\n  - 输入变量：`FILE_DELETE`（是否删除文件）、`TIMEOUT`（超时时间）、`DTI`（日期时间信息）、`DTI_OFFSET`（日期时间偏移量）、`RETRY`（重试次数）、`RETRY_TIME`（重试间隔时间）、`DNS_IP4`（DNS IP 地址）。\n  - 输出变量：`DONE`（完成标志）、`BUSY`（忙标志）、`ERROR_C`（错误代码）、`ERROR_T`（错误类型）。\n  - 内部变量：`UCBD`（循环缓冲区数据）、`UCB`（循环缓冲区实例）、`SMTP_CLIENT`（SMTP 客户端实例）、`WT_1`（定时器实例）、`ftrig_old`（文件触发标志旧值）、`files`（文件列表）、`step`（状态机步骤）、`smtp_busy`（SMTP 忙标志）、`smtp_done`（SMTP 完成标志）、`cnt`（重试计数器）。\n\n- - 主逻辑部分\n  -- REGION 文件触发处理\n     当检测到新文件时（通过 `X.NEW_FILE_RTRIG` 的上升沿），将新文件添加到循环缓冲区中。具体步骤如下：\n     - 设置 `UCBD.D_HEAD` 为 1，表示从缓冲区头部开始操作。\n     - 设置 `UCBD.D_MODE` 为 1，表示添加数据到缓冲区。\n     - 将 `X.NEW_FILE`（新文件名）赋值给 `UCBD.D_STRING`。\n     - 调用 `UCB` 功能块，将数据添加到循环缓冲区中。\n     - 使用 `ftrig_old` 存储上一个周期的触发状态，以便检测上升沿。\n\n  -- REGION 状态机控制\n     状态机通过 `step` 变量控制整个流程，分为多个步骤：\n     - **步骤 00**：\n       - 检查循环缓冲区中是否有数据（`UCBD.BUF_COUNT > 0`）且 SMTP 客户端是否空闲（`smtp_busy = FALSE`）。\n       - 如果满足条件，设置 `UCBD.D_MODE` 为 12，表示从缓冲区读取数据。\n       - 调用 `UCB` 功能块，读取文件列表并存储到 `files` 变量中。\n       - 如果 `FILE_DELETE` 为真，在文件名后添加 `;#DEL#` 标记，表示文件需要删除。\n       - 初始化重试计数器 `cnt` 为 `RETRY` 的值。\n       - 进入步骤 10。\n\n     - **步骤 10**：\n       - 检查 SMTP 客户端是否空闲（`smtp_busy = FALSE`）。\n       - 如果 `smtp_done` 为真，表示邮件发送成功，回到步骤 00。\n       - 如果 `smtp_done` 为假，进入步骤 20，准备重试。\n\n     - **步骤 20**：\n       - 检查定时器 `WT_1` 是否超时（`WT_1.Q` 为真）。\n       - 如果超时，减少重试计数器 `cnt`。\n       - 如果 `RETRY` 为 0，表示不限制重试次数，回到步骤 10。\n       - 如果 `cnt >= 0`，表示还有重试次数，回到步骤 10。\n       - 如果 `cnt < 0`，表示重试次数耗尽，回到步骤 00，结束流程。\n\n  -- REGION SMTP 邮件发送\n     在步骤 10 和步骤 20 中，调用 `SMTP_CLIENT` 功能块发送邮件。具体步骤如下：\n     - 设置 `ACTIVATE` 为 `BUSY`，激活 SMTP 客户端。\n     - 传递配置参数，包括 `TIMEOUT`（超时时间）、`DTI`（日期时间信息）、`DTI_OFFSET`（日期时间偏移量）、`DNS_IP4`（DNS IP 地址）。\n     - 传递邮件内容，包括 `SERVER`（邮件服务器地址）、`MAILFROM`（发件人地址）、`MAILTO`（收件人地址）、`SUBJECT`（邮件主题）、`BODY`（邮件正文）。\n     - 传递文件列表 `FILES`，包含要发送的文件名。\n     - 监控 `smtp_done` 和 `smtp_busy`，分别表示 SMTP 客户端是否完成和是否忙。\n\n  -- REGION 错误处理\n     在邮件发送完成后，检查是否发生错误：\n     - 如果 `SMTP_CLIENT.ERROR_T` 不为 0，表示 SMTP 客户端返回错误，将错误代码和类型存储到 `ERROR_C` 和 `ERROR_T`。\n     - 如果循环缓冲区数据丢失（`UCBD.BUF_DATA_LOST > 0`），设置错误代码为 `DWORD#2`，错误类型为 `BYTE#6`。\n     - 如果缓冲区使用率超过 90%（`UCBD.BUF_USED_MAX > 90`），设置错误代码为 `DWORD#1`，错误类型为 `BYTE#6`。\n     - 如果没有错误，清除错误信息，设置 `ERROR_C` 为 `DWORD#0`，`ERROR_T` 为 `BYTE#0`。\n\n  -- REGION 输出更新\n     根据状态机的当前步骤更新输出变量：\n     - `BUSY`：在步骤 10 时为真，表示功能块正在处理。\n     - `DONE`：在步骤 0 时为真，表示处理完成。\n     - 定时器 `WT_1` 在步骤 20 时启动，用于控制重试间隔时间。\n     - 如果 `SMTP_CLIENT` 返回错误，将错误信息传递到 `ERROR_C` 和 `ERROR_T`。", "name": "DLOG_FILE_TO_SMTP"}